<meta charset="utf-8">
<script src="raphael-min.js"></script>
<style>
  textarea {
    position: absolute;
    right: 0px;
    width: 400px;
    height: 100%;
  }
</style>
<script>
var points = '{"0":[{"x":344,"y":295},{"x":345,"y":320},{"x":373,"y":319},{"x":367,"y":300}],"0.04":[{"x":346,"y":297},{"x":346,"y":317},{"x":372,"y":317},{"x":369,"y":300}],"0.08":[{"x":346,"y":297},{"x":346,"y":317},{"x":372,"y":317},{"x":369,"y":300}],"0.2":[{"x":254,"y":265},{"x":257,"y":290},{"x":282,"y":290},{"x":278,"y":269}],"0.24000000000000002":[{"x":178,"y":219},{"x":178,"y":242},{"x":200,"y":242},{"x":201,"y":220}],"0.28":[{"x":51,"y":93},{"x":51,"y":115},{"x":79,"y":117},{"x":78,"y":90}],"0.32":[{"x":38,"y":71},{"x":39,"y":91},{"x":57,"y":90},{"x":57,"y":71}],"0.36":[{"x":38,"y":71},{"x":39,"y":91},{"x":57,"y":90},{"x":57,"y":71}],"0.39999999999999997":[{"x":38,"y":71},{"x":39,"y":91},{"x":57,"y":90},{"x":57,"y":71}],"0.43999999999999995":[{"x":33,"y":69},{"x":36,"y":89},{"x":54,"y":89},{"x":51,"y":70}],"0.4799999999999999":[{"x":30,"y":68},{"x":33,"y":88},{"x":49,"y":88},{"x":47,"y":67}],"0.5199999999999999":[{"x":18,"y":58},{"x":21,"y":80},{"x":37,"y":77},{"x":37,"y":60}],"0.5599999999999999":[{"x":17,"y":35},{"x":17,"y":51},{"x":4,"y":50},{"x":4,"y":40}],"0.6":[{"x":4,"y":31},{"x":15,"y":28},{"x":13,"y":9},{"x":4,"y":8}]}';

function PointsReplayer(timecode, video) {
  this.timecode = timecode;
  this.video = video;
  this.holder = putOverlayOnVideo(video);
  document.body.appendChild(this.holder);
  this.r = Raphael(this.holder, this.holder.style.width, this.holder.style.height);
  this.path = this.r.set();
}

PointsReplayer.prototype.tick = function() {
  if (this.video.currentTime > 0.6) {
    return;
  }
  if (this.video.paused) {
    return;
  }
  var prev = 0;

  // find the closest time
  for (var time in this.timecode) {
    if (this.video.currentTime < time) {
      break;
    }
    prev = time;
  }
  this.clear();
  this.display(this.timecode[prev]);
  requestAnimationFrame(this.tick.bind(this));
}

PointsReplayer.prototype.play = function() {
  var _this = this;
  this.video.addEventListener("playing", function() {
    _this.tick();
    requestAnimationFrame(_this.tick.bind(_this));
  });
  this.video.play();
  this.video.playbackRate = 0.1;
}

PointsReplayer.prototype.clear = function() {
  this.r.clear();
}

PointsReplayer.prototype.display = function(path) {
  var str = path2string(path);
  this.path.clear();
  this.path.push(this.r.path(str).attr({stroke: "rgba(0, 0, 0, 0.3)", fill: "rgba(0, 0, 0, 0.1)"}));
}

PointsReplayer.prototype.pause = function() {
  this.video.pause();
}

function putOverlayOnVideo(v) {
  var holder = document.createElement("div");
  holder.style.position = "absolute";
  var rect = this.rect =v.getBoundingClientRect();
  // overlay
  holder.style.top = rect.top;
  holder.style.left = rect.left;
  holder.style.width = rect.width;
  holder.style.height = rect.height;
  // this.holder.style.backgroundColor = "rgba(255, 0, 0, 0.2)";
  return holder;
}

function PointsRecorder(outelement, video) {
  this.outelement = outelement;
  this.video = video;
  this.outelement.value = "var points = {";
  this.videoFps = 25;
  this.points = {};
  this.startFrame();
  this.rect = video.getBoundingClientRect();
  this.holder = putOverlayOnVideo(video);
  this.holder.style.backgroundColor = "rgba(255, 0, 0, 0.2)";
  document.body.appendChild(this.holder);
  this.r = Raphael(this.holder, this.holder.style.width, this.holder.style.height);
  this.path = this.r.set();
  var _this = this;
  this.holder.addEventListener("click", function(e) {
    _this.addPoint(e.layerX, e.layerY);
  });
  // progress
  this.progress = document.createElement("div");
  this.progress.style.position = "absolute";
  this.progress.style.top = rect.bottom + 1;
  this.progress.style.left = rect.left;
  this.progress.style.width = "0px";
  this.progress.style.height= "10px";
  this.progress.style.backgroundColor = "black";
  document.body.appendChild(this.progress);
}

PointsRecorder.prototype.nextFrame = function() {
  this.endFrame();
  this.video.currentTime += 1 / this.videoFps;
  this.progress.style.width = (this.video.currentTime / this.video.duration *
      this.rect.width) + "px";
}

PointsRecorder.prototype.resetCurrent = function() {
  this.points[this.currentTime] = [];
}

PointsRecorder.prototype.startFrame = function() {
  console.log("startFrame");
}

PointsRecorder.prototype.addPoint = function(x, y) {
  if (this.points[this.video.currentTime] == undefined) {
    this.points[this.video.currentTime] = [];
  }
  this.points[this.video.currentTime].push({x: x, y: y});
}

function path2string(path) {
  var str = "M";
  str += path[0].x + "," + path[0].y;
  for(var i = 1; i < path.length; i++) {
    str += "L" + path[i].x + "," + path[i].y;
  }
  str += "Z";
  return str;
}

PointsRecorder.prototype.endFrame = function() {
  var path = this.points[this.video.currentTime];
  // keep the last point
  if (!path) {
    this.points[this.video.currentTime] = this.points[this.video.currentTime - 1 / this.video.fps];
  } else {
    var str = path2string(path);
    this.path.push(this.r.path(str).attr({stroke: "rgba(0, 0, 0, 0.3)", fill: "rgba(0, 0, 0, 0.1)"}));
  }
  this.outelement.value = JSON.stringify(this.points);
}

window.addEventListener("load", function() {
    console.log("loaded.");
    var v = document.querySelector("video");
    // {
    //   0.0  : [ {x: 4, y: 5}, {x: 100, y: 300}],
    //   0.16 : [ {x: 30, y: 50}, {x: 200, y: 200}]
    // }
    v.fps = 25;
    // var rec = new PointsRecorder(document.querySelector("#points"), v);
    var rec = new PointsReplayer(JSON.parse(points), v);
    rec.play();


    window.addEventListener("keypress", function(e) {
      // letter 'n' for next
      if (e.key == 'n' || e.keyCode == 110) {
        rec.nextFrame();
      }
    });
});
</script>
<video src=moving-icon.webm>
</video>
<div id=progress></div>
<textarea id=points>
</textarea>
